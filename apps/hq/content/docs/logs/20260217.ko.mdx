---
title: "2026-02-17"
description: "PlanetScale Postgres용 Better Auth + Drizzle ORM 데이터베이스 레이어 구축"
---

## Better Auth Drizzle 데이터베이스 기반 구축

**범위**: `apps/web`

### 변경 사항

| 파일 | 변경 사항 |
| --- | --- |
| `apps/web/src/lib/db/client.ts` | PlanetScale Postgres 호환을 위해 `prepare: false`를 적용한 postgres.js Drizzle 클라이언트 추가. |
| `apps/web/src/lib/db/schema.ts` | Better Auth 기본 스키마를 CLI로 생성하고 OpenAI 키 메타데이터용 `organization_settings` 커스텀 테이블 추가. |
| `apps/web/src/lib/db/index.ts` | `db` 및 스키마 심볼 배럴 export 추가. |
| `apps/web/drizzle.config.ts` | `dialect: "postgresql"` 기반 Drizzle Kit 설정 및 schema/output 경로 추가. |
| `apps/web/package.json` | `db:generate`, `db:push`, `db:studio` 스크립트 추가. |
| `apps/web/.gitignore` | 생성 산출물 제외를 위해 `drizzle/` 규칙 추가. |
| `.sisyphus/notepads/better-auth-migration/learnings.md` | Better Auth 스키마 생성 제약 및 테이블 관계 학습 내용 추가. |

### 기술적 결정

1. **인증 스키마 우선 생성**: Better Auth CLI 출력(`user/session/account/verification/organization/member/invitation`)을 기준 스키마로 사용하고, 앱 전용 테이블만 확장.
2. **텍스트 ID 일관성 유지**: Better Auth 기본 규약에 맞춰 `organization_settings.id`를 text PK로 정의하고 UUID 컬럼 타입을 도입하지 않음.
3. **조직 메타데이터 이전 모델**: 기존 Clerk organization metadata의 `openaiApiKey`/`hasOpenAIKey`를 `organization_settings` 컬럼으로 명시적 저장.

### 검증

- TypeScript: 통과 (`bun run type-check`)
- Build: 통과 (`bun run build`)
- Tests: 미실행 (요청 없음)
- Drizzle check: 통과 (`npx drizzle-kit check`)
- Drizzle push: 실패 (현재 환경에 `DATABASE_URL` 없음)

### 다음 단계

1. `apps/web` 실행 환경에 `DATABASE_URL` 설정.
2. `npx drizzle-kit push` 재실행 후 PlanetScale 테이블 생성 성공 증거 갱신.

## Better Auth 서버 구성 (Task 6)

**범위**: `apps/web`

### 변경 사항

| 파일 | 변경 사항 |
| --- | --- |
| `apps/web/src/lib/auth.ts` | Drizzle 어댑터(`provider: "pg"`), 이메일/비밀번호 로그인, Google/GitHub 소셜 로그인, Organization 플러그인, 마지막 `nextCookies()`를 포함한 Better Auth 서버 구성을 추가. |
| `apps/web/src/app/api/auth/[...all]/route.ts` | `toNextJsHandler(auth)` 기반 App Router 캐치올 핸들러를 추가하고 `GET`/`POST`를 export. |
| `.sisyphus/notepads/better-auth-migration/decisions.md` | Task 6 인증 구성 결정 사항과 플러그인 순서 근거를 추가. |
| `.sisyphus/evidence/task-6-build.txt` | `bun run build` 실행 결과 증거를 저장. |
| `.sisyphus/evidence/task-6-auth-ok.txt` | `curl -i http://localhost:3000/api/auth/ok`의 200 응답 증거를 저장. |

### 기술적 결정

1. **서버 인증 단일 진입점**: API 라우트, 서버 컴포넌트, 서버 액션에서 공통으로 사용하도록 `src/lib/auth.ts`에 Better Auth 설정을 집중했다.
2. **플러그인 순서 고정**: `organization({ allowUserToCreateOrganization: true })` 뒤에 `nextCookies()`를 마지막으로 배치해 서버 액션의 Set-Cookie 반영을 보장했다.
3. **범위 고정 구성**: 마이그레이션 범위에 맞춰 이메일/비밀번호 + Google/GitHub만 활성화하고, 이메일 검증/MFA/비밀번호 재설정 및 초대 메일 핸들러는 의도적으로 제외했다.

### 검증

- LSP diagnostics: 통과 (`src/lib/auth.ts`, `src/app/api/auth/[...all]/route.ts`)
- Build: 통과 (`bun run build`)
- API health: 통과 (`curl -i http://localhost:3000/api/auth/ok` → `HTTP/1.1 200`)
- Tests: 미실행 (요청 없음)

### 다음 단계

1. 보호 라우트에 Better Auth 세션 검증(프록시/페이지 단)을 연결.
2. 조직 설정 API 라우트의 Clerk 의존을 Better Auth 조직/세션 API로 전환.

## Better Auth 프록시 미들웨어 재작성 (Task 8)

**범위**: `apps/web`

### 변경 사항

| 파일 | 변경 사항 |
| --- | --- |
| `apps/web/src/proxy.ts` | Clerk 미들웨어를 제거하고 `getSessionCookie` 기반 Better Auth 쿠키 체크로 전환했으며, next-intl 미들웨어 통합과 `?locale=` 쿠키 전환 로직을 유지. |
| `apps/web/src/proxy.ts` | 세션 쿠키가 없을 때 `/:locale/profile`, `/:locale/:orgSlug/settings`를 `/sign-in`으로 리다이렉트하도록 보호 라우트 정책을 추가. |
| `apps/web/src/proxy.ts` | 세션 쿠키가 있을 때 `/sign-in`, `/sign-up` 접근 시 로케일 홈으로 리다이렉트하도록 추가. |
| `apps/web/src/proxy.ts` | 설정 라우트에서 org slug가 로케일 문자열과 충돌하면 거부하도록 충돌 방지 가드를 추가. |
| `.sisyphus/notepads/better-auth-migration/issues.md` | Task 8 라우팅 엣지 케이스와 미들웨어 주의사항을 기록. |
| `.sisyphus/evidence/task-8-build.txt` | 빌드 검증 결과와 차단 오류 컨텍스트를 저장. |
| `.sisyphus/evidence/task-8-curl.txt` | curl QA 시나리오 명령과 HTTP 상태 결과를 저장. |
| `.sisyphus/evidence/task-8-lsp.txt` | 수정 파일 LSP 진단 결과를 저장. |

### 기술적 결정

1. **미들웨어에서는 쿠키 존재 여부만 확인**: Edge 환경 안전성과 비용을 위해 DB 조회 없이 `getSessionCookie(request.headers)`만 사용.
2. **로케일 접두 경로 정규화**: `/en/sign-in`, `/en/sign-up`도 동일한 인증 페이지 리다이렉트 규칙을 적용하도록 경로를 정규화.
3. **라우팅 충돌 선제 차단**: 설정 라우트에서 로케일 코드를 org slug로 허용하지 않아 locale/org 경로 충돌을 미들웨어에서 차단.

### 검증

- LSP diagnostics: 통과 (`apps/web/src/proxy.ts`)
- Build: 실패 (`bun run build`) — prerender 중 기존 Clerk 런타임 의존(`useClerk`) 오류로 중단됨 (프록시 재작성 범위 외)
- Curl 라우트 확인: 현재 로컬 실행에서 실패 (`/en/profile`이 기대값 `307` 대신 `404` 반환)
- Tests: 미실행 (요청 없음)

### 다음 단계

1. 페이지/렌더 경로의 잔여 Clerk 의존성을 제거해 빌드가 `useClerk` 오류 없이 완료되도록 정리.
2. Next.js 16 프록시 실행 경로를 로컬에서 재확인한 뒤 curl QA를 재실행해 `307` 리다이렉트를 검증.
