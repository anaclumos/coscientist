---
title: "2026-02-17"
description: "Set up Drizzle ORM database layer for Better Auth on PlanetScale Postgres"
---

## Better Auth Drizzle Database Foundation

**Scope**: `apps/web`

### Changes Made

| File | Change |
| --- | --- |
| `apps/web/src/lib/db/client.ts` | Added postgres.js Drizzle client with `prepare: false` for PlanetScale Postgres compatibility. |
| `apps/web/src/lib/db/schema.ts` | Generated Better Auth core schema and added custom `organization_settings` table for OpenAI key metadata. |
| `apps/web/src/lib/db/index.ts` | Added database barrel export for `db` and schema symbols. |
| `apps/web/drizzle.config.ts` | Added Drizzle Kit config with `dialect: "postgresql"` and schema/output paths. |
| `apps/web/package.json` | Added `db:generate`, `db:push`, and `db:studio` scripts. |
| `apps/web/.gitignore` | Added `drizzle/` ignore rule for generated migration artifacts. |
| `.sisyphus/notepads/better-auth-migration/learnings.md` | Documented Better Auth schema generation constraints and table relationships. |

### Technical Decisions

1. **CLI-generated auth schema first**: Used Better Auth CLI output for canonical `user/session/account/verification/organization/member/invitation` table definitions, then extended with one custom app table.
2. **Text primary key consistency**: Kept `organization_settings.id` as text PK to match Better Auth text ID convention and avoid UUID column types.
3. **Organization metadata migration target**: Modeled `openai_api_key` and `has_openai_key` directly in `organization_settings` to replace prior Clerk org metadata storage pattern.

### Verification

- TypeScript: Pass (`bun run type-check`)
- Build: Pass (`bun run build`)
- Tests: Not run (not requested)
- Drizzle check: Pass (`npx drizzle-kit check`)
- Drizzle push: Fail (`DATABASE_URL` not available in current environment)

### Next Steps

1. Set `DATABASE_URL` for `apps/web` runtime environment.
2. Re-run `npx drizzle-kit push` to create tables in PlanetScale and capture success evidence.

## Better Auth Server Configuration (Task 6)

**Scope**: `apps/web`

### Changes Made

| File | Change |
| --- | --- |
| `apps/web/src/lib/auth.ts` | Added Better Auth server configuration with Drizzle adapter (`provider: "pg"`), email/password auth, Google + GitHub providers, Organization plugin, and `nextCookies()` as final plugin. |
| `apps/web/src/app/api/auth/[...all]/route.ts` | Added Next.js App Router catch-all handler using `toNextJsHandler(auth)` and exported `GET`/`POST`. |
| `.sisyphus/notepads/better-auth-migration/decisions.md` | Appended Task 6 auth configuration decisions and plugin ordering rationale. |
| `.sisyphus/evidence/task-6-build.txt` | Captured `bun run build` output evidence. |
| `.sisyphus/evidence/task-6-auth-ok.txt` | Captured `curl -i http://localhost:3000/api/auth/ok` 200 response evidence. |

### Technical Decisions

1. **Server auth source of truth**: Centralized Better Auth config in `src/lib/auth.ts` to support shared use across API routes, server components, and server actions.
2. **Org-first plugin chain**: Registered `organization({ allowUserToCreateOrganization: true })` before `nextCookies()` and kept `nextCookies()` last to preserve Set-Cookie interception for server actions.
3. **Provider scope control**: Enabled only email/password plus Google/GitHub social login to match migration scope, intentionally excluding verification/MFA/password reset and invitation email handlers.

### Verification

- LSP diagnostics: Pass (`src/lib/auth.ts`, `src/app/api/auth/[...all]/route.ts`)
- Build: Pass (`bun run build`)
- API health: Pass (`curl -i http://localhost:3000/api/auth/ok` returned `HTTP/1.1 200`)
- Tests: Not run (not requested)

### Next Steps

1. Wire Better Auth session checks into proxy/page guards for protected routes.
2. Replace Clerk usage in organization settings API route with Better Auth organization/session APIs.

## Better Auth Proxy Middleware Rewrite (Task 8)

**Scope**: `apps/web`

### Changes Made

| File | Change |
| --- | --- |
| `apps/web/src/proxy.ts` | Replaced Clerk middleware with Better Auth cookie check (`getSessionCookie`), preserved next-intl routing middleware integration, and kept locale query-param cookie switching logic. |
| `apps/web/src/proxy.ts` | Added protected-route redirects for `/:locale/profile` and `/:locale/:orgSlug/settings` to `/sign-in` when session cookie is absent. |
| `apps/web/src/proxy.ts` | Added signed-in redirect behavior for `/sign-in` and `/sign-up` to locale home. |
| `apps/web/src/proxy.ts` | Added org-slug collision guard to reject locale strings as org slugs in settings routes. |
| `.sisyphus/notepads/better-auth-migration/issues.md` | Appended Task 8 routing edge cases and middleware caveats. |
| `.sisyphus/evidence/task-8-build.txt` | Captured build verification result and blocking error context. |
| `.sisyphus/evidence/task-8-curl.txt` | Captured curl QA scenario commands and observed HTTP status codes. |
| `.sisyphus/evidence/task-8-lsp.txt` | Captured LSP diagnostics result for updated proxy file. |

### Technical Decisions

1. **Cookie-existence middleware check only**: Used `getSessionCookie(request.headers)` in proxy to avoid DB access and keep middleware edge-safe.
2. **Locale-aware path normalization**: Normalized locale-prefixed paths before auth-page checks so `/en/sign-in` and `/en/sign-up` follow signed-in redirects consistently.
3. **Slug collision prevention at middleware boundary**: Treated locale codes as invalid org slugs for settings routes and redirected to locale home to prevent locale/org routing ambiguity.

### Verification

- LSP diagnostics: Pass (`apps/web/src/proxy.ts`)
- Build: Fail (`bun run build`) due to existing Clerk usage during prerender (`useClerk` outside `ClerkProvider`), outside proxy rewrite scope
- Curl route checks: Fail in current local run (`/en/profile` returned `404` instead of expected `307`)
- Tests: Not run (not requested)

### Next Steps

1. Remove remaining Clerk runtime usage from page/render paths so build can complete without `useClerk` errors.
2. Validate Next.js 16 proxy execution path for locale-prefixed URLs in local environment and re-run curl QA to confirm `307` redirects.
