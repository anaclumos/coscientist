import type { Metadata } from "next"
import { unstable_cache as nextCache } from "next/cache"
import { hasLocale } from "next-intl"
import { routing } from "@/i18n/routing"
import { getAllNoteSlugs, getNoteBySlug } from "@/lib/notes"

export const dynamicParams = false

const getCachedNote = nextCache(
  async (slug: string, locale: string) => getNoteBySlug(slug, locale),
  ["note-metadata"],
  { revalidate: false }
)

export async function generateMetadata({
  params,
}: {
  params: Promise<{ locale: string; slug?: string[] }>
}): Promise<Metadata> {
  const { locale, slug } = await params

  if (!hasLocale(routing.locales, locale)) {
    return {}
  }

  const rootSlug = slug?.[0] ?? "index"
  const note = await getCachedNote(rootSlug, locale)

  if (!note) {
    // Avoid getTranslations() here as it depends on request data,
    // which is incompatible with static generation in Next.js 16+
    return {
      title: "Coscientist",
      description: "Your intellectual companion for the post-AI era",
    }
  }

  const title = note.title
  const description = note.description || note.excerpt

  return {
    title,
    description,
    openGraph: {
      title,
      description,
      type: "article",
      locale,
      images: [
        {
          url: `/api/og?title=${encodeURIComponent(title)}&description=${encodeURIComponent(description || "")}&locale=${locale}`,
          width: 2400,
          height: 1260,
          alt: title,
        },
      ],
    },
    twitter: {
      card: "summary_large_image",
      title,
      description,
      images: [
        `/api/og?title=${encodeURIComponent(title)}&description=${encodeURIComponent(description || "")}&locale=${locale}`,
      ],
    },
  }
}

export async function generateStaticParams() {
  const slugs = await getAllNoteSlugs(routing.defaultLocale)

  const params: Array<{ locale: string; slug: string[] | undefined }> = []
  for (const locale of routing.locales) {
    params.push({ locale, slug: undefined })
    for (const slug of slugs) {
      params.push({ locale, slug: [slug] })
    }
  }

  return params
}
